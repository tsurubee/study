# はじめてUNIXで仕事をする人が読む本
## 第1章 ログイン/ログアウト
### TELNETによるリモートログイン
TELNETは遠隔のホストに接続し端末から操作できるようにするためのプロトコルであり、UNIXに搭載されている標準的なTELNETクライアントがtelnetコマンドである。
```sh
telnet ホスト名 (ポート番号)
```
* ユーザ名・パスワードは平文のままネットワークを流れる  
* テキストベースの汎用TCPクライアントとして用いることもできる

### SSHによるリモートログイン
SSHプロトコルで通信するプログラムの実装の1つが、OpenSSHである。  
SSHを使うと以下の機能により安全にログインができる。  
* 通信経路の暗号化による盗聴防止
* サーバ認証を用いた、サーバのなりすまし防止
* パスワードでけでなく、公開鍵認証方式を用いたユーザ認証
* 通信パケットの完全性の保証による通信内容の改ざん防止
```sh
ssh ユーザ名@ホスト名
```

## 第2章 UNIXの基本操作
### 環境変数とシェル変数
シェルはシェル変数のみを持ち、環境変数はプロセスごとに割り当てられた変数空間である。  
環境変数には、設定情報やプログラムの挙動を指定する値を代入する。プログラムを実行すると、実行元の環境変数のコピーが渡されるため、**環境変数は自分自身と自分の子どもにしか影響を与えない**  
シェル変数は、そのシェルの中でだけ使える変数である。  
シェル変数の代入に=文を、シェル変数を環境変数にするためにexport文を使う。  
```sh
LANG=C  （シェル変数への代入）
export LANG  （シェル変数を環境変数にする）
```

### UNIXのファイルシステム
UNIXのファイルシステムではデータ形式を強要せず**バイトストリーム**として扱う。  
<ディレクトリ構成>  
/  
├── bin　　　Linuxシステムの動作に必要な重要度の高いコマンドを格納  
├── dev　　  デバイスファイル（ハードウェアをファイルとして扱えるようにしたもの）を格納  
├── etc　　　設定ファイルを格納  
├── home　  ユーザ用ディレクトリを格納  
├── lib　　　/binや/sbinにあるコマンドの実行に必要なライブラリ  
├── mnt　　　ファイルシステムの一時マウントに用いる  
├── sbin　　 管理者ユーザ向けのコマンドを格納  
├── tmp　　  一時的なファイルを格納（定期的に削除する設定になっている場合が多い）  
├── usr　　　各種アプリケーションとその付随ファイルを格納（内部にルートディレクトリと似た構造をもつ）  
└── var　　　変化するデータを格納（ログやメールなど）  

### 正規表現
正規表現とは、文字の種類や出現順序の規則によるテキストの表現方法である。  
UNIXのいくつかのツールは、文字列の検索や編集のために、正規表現を使用する。  

#### grep
```sh
grep pattern filename
```
※正規表現で使用する記号がシェルで解釈されてしまうことがあるため、シングルクォートやダブルクォートでくくる

#### sed
stream editorの略。ファイルや標準入力から読み取ったデータを、指定されたコマンドに基づいて編集して出力する。  
パターンマッチだけでなく、文字列の置換や並び替えといった、より複雑な編集を行うことができる。  
```sh
sed 'script' filename
```
filenameから読み込んだ各行に対してscriptで指定された処理を施し、その結果を標準出力に書き出す。  

#### awk
awkは、指定された入力を1行ずつ読み込み、パターンにマッチした行に対してある処理を実行する。  
```sh
awk 'program' filename
```
programは以下の形式で記述する。
```
pattern { action }
pattern { action }
・・・
```

## 第3章 テキストエディタ
#### Vim
vimはviに数々の拡張機能を加えた高機能なエディタ。  
設定を~/.vimファイル（もしくは~/.vimrc）から起動時に読むこむため、各自で~/.vimファイルを変更することでVimの動作をカスタマイズできる。  
'vimtutor'と入力すると、Vimのチュートリアルを始めることができる。

##### QuickFix
VimにはQuickFixと呼ばれる機能がある。QuickFixとは、エラー結果やgrepの結果が表示される専用のウィンドウ領域のこと。  
QuickFixは「:copen」で開いて、「:cclose」で閉じる。  

## 第4章 作業の自動化（シェルスクリプト）
### シェルスクリプトによる作業自動化の必要性と利点
* 繰り返し行われる定型的な作業を自動化できる  
* オペレーション時のケアレスミスが起きにくくなる  
* 処理の再利用が可能になる  

## 第5章 オンラインマニュアル
### manコマンド
オンラインマニュアルを表示するコマンド。
#### セクションの指定
```
man 1 printf
あるいは
man -s 1 printf
```
#### キーワード検索
```
$ man -k automatically
alloca (3)           - allocate memory that is automatically freed
grub-mkdevicemap (8) - make a device map file automatically
```
### infoコマンド
infoコマンドはmanコマンドと同様にオンラインマニュアルを表示するコマンド。  
manよりも新しいこともあって優れている点も多いが、操作性に癖がある。
以下のような特徴がある。  

## 第6章 セキュリティ
### ルート権限の獲得方法
#### suコマンド
su（Substitute User）コマンドは、引数が省略された場合は、ルート権限でルートのシェルを実行する。  
引数として「-」を与えると、元のユーザの環境変数やカレントディレクトリなどの環境を引き継がない。  
引数としてユーザ名を与えると、そのユーザ権限でシェルを立ち上げる。  
#### sudoコマンド
sudoの設定はsudoersファイルに記述されており、visudoコマンドを使って編集することができる。

### SSHの応用
#### scp
SSHによる通信経路を使ってファイルをコピーする。
・リモート → ローカル
```
scp ホスト名:パス名 ローカルのパス名
```
・ローカル → リモート
```
scp ローカルのパス名 ホスト名:パス名
```

## 第7章 UNIXシステム管理  
### TCP/IPネットワーク管理  
ネットワークインターフェイスの設定を行うために`ifconfig`を用いることがあるが、Linuxではifconfigコマンドはメンテナンスされていない過去のコマンドであり、現在はiproute2パッケージのipコマンドを用いるのが適切な方法とされている。  
OSが内部で保持している宛先ごとの中継ルータの情報を**ルーティングテーブル**と呼ぶ。  
ルーティングテーブルを表示するには'netstat -r'コマンドを使用する。  
```
$ netstat -rn
Kernel IP routing table
Destination     Gateway         Genmask         Flags   MSS Window  irtt Iface
0.0.0.0         10.0.2.2        0.0.0.0         UG        0 0          0 enp0s3
10.0.2.0        0.0.0.0         255.255.255.0   U         0 0          0 enp0s3
```
### 名前解決
名前解決とは、ホスト名を対応するIPアドレスに変換する処理のことである。  
以下の手順のいずれかが用いられる。  
1. /etc/hostsファイルに記載されている対応付けを参照する  
＜例＞  
/etc/hosts
```
127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
::1         localhost localhost.localdomain localhost6 localhost6.localdomain6
```
2. DNS（Domain Name Service）サーバと通信し検索を行う  
DNSはIPアドレスを検索するための広域分散データベースである。

### トラブルシュート
* プロセスの状態の確認
```
$ ps f
  PID TTY      STAT   TIME COMMAND
 4090 pts/0    Ss     0:00 -bash
 4141 pts/0    R+     0:00  \_ ps f
```
lsofコマンドを使うと現在実行中のプロセスがどのファイルをオープンしているかを知ることができる。  
（標準ではインストールされていないことが多い）  
```
$ lsof
COMMAND    PID  TID    USER   FD      TYPE DEVICE  SIZE/OFF     NODE NAME
systemd      1         root  cwd   unknown                           /proc/1/cwd
systemd      1         root  rtd   unknown                           /proc/1/root
```

* ネットワークの使用状況  
```
$ netstat -a
Active Internet connections (servers and established)
Proto Recv-Q Send-Q Local Address           Foreign Address         State
tcp        0      0 0.0.0.0:ssh             0.0.0.0:*               LISTEN
tcp        0      0 localhost:smtp          0.0.0.0:*               LISTEN
```
引数なしだと通信中のセッションの情報しか得られないが、-aオプションを指定すると、待ち受け状態の情報も表示される。  
-rオプションを指定すると、ホストのルーティング情報を表示する。

* pingコマンド
```
ping [hostname]
```
実行したホストから引数に指定したホストに対してパケットを送出し、それに対しての返答があったかどうかを調べる。  
※ ただし昨今では、ファイアウォール等の設定でpingが使用しているICMPパケットを遮断している場合も多く、このような場合、pingコマンドに対する応答が得られない。したがって、pingコマンドは応答があった場合に正常だという判断を導くためのものだと考える方がよい。

* traceroute
```
traceroute [hostname]
```
tracerouteコマンドは対象となるマシンへの経路をたどって表示する。

* TELNET
telnetは、元々はローカルのマシンからリモートのマシンにログインするためのコマンドであった。しかし、TELNETプロトコルは端末操作の内容が暗号化されずにネットワークを流れるため、この目的でインターネット経由で使われることは現在では少ない。  
一方、telnetコマンドは接続先ポートを指定して、汎用のTCPクライアントとして使うこともできる。
```
telnet [hostname] http
あるいは
telnet [hostname] 80
```
pingやtracerouteと異なり、実際に接続できるはずのサービスに接続するため、ネットワークに問題があるか、アプリケーションに問題があるかの切り分けがしやすくなる。
