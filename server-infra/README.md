# サーバ/インフラを支える技術  
## 用語の整理
* CDN（Content Delivery Network）：コンテンツを配信するためのネットワークシステム。世界中に点在するキャッシュサーバの中から、クライアントにより近いキャッシュサーバを選び配信することにより、性能向上を実現している。  
* LVS（Linux Virtual Server）：Linuxでスケーラブルで可用性の高いシステムを作ろうと目指しているプロジェクト。（慣習的に「Linuxで作ったロードバランサ」を指すこともある）その成果物の一つにLinuxロードバランサのためのIPVSがある。  
* フェイルオーバ（Failover）：冗長化されたシステムにおいて、Activeなノードが停止した際に、自動的にBackupノードに切り替わること。自動ではなく手動で切り替えることは「スイッチオーバ」という。  
* ヘルスチェック（Health Check）：監視対象が正常な状態にあるかどうか確認をすること。例えば、Webサーバに対して、pingが通るか、TCPの80番ポートに接続できるか、HTTPの応答があるか、など。  
* レイテンシ（latency）：データが届くまでの時間を意味する。（cf. スループットは単位時間あたりのデータ転送量）  

## 1章 サーバ/インフラ構築入門  
### 1.1 冗長化の基本
　冗長化とは、障害が発生しても予備の機材でシステムの機能を継続できるようにすること。  
以下のステップが必要である。  
1. 障害を想定する  
2. 障害に備えて予備の機材を準備する  
3. 障害が発生した際に予備の機材に切り替えられる運用体制を整備する  

冗長化されたシステムでは「現用機と予備機の構成を常に同じ状態にしておくことが定石」  
#### コールドスタンバイとホットスタンバイ
ルータなどのネットワーク機器は、運用中に頻繁に設定を変えることもないため、蓄積しなければならないデータもほとんどなく、コールドスタンバイでの運用は現実的な選択肢の一つである。  
一方で、Webサーバの場合、サイトの内容は日々更新されたり、OSのバージョンアップなども避けては通れない。そのため、Webサーバの予備機は常に電源を入れておいて、現用機が内容を更新する際には予備機にも同じ更新がかかるような運用にしたほうがよい。これをホットスタンバイという。  

### 1.2 Webサーバを冗長化する 〜DNSラウンドロビン〜
DNSラウンドロビンとは、DNSを利用して一つのサービスに複数台のサーバを分散させる手法。  
DNSサーバは、同じ名前に複数のレコードが登録されると、問い合わせのたびに異なる結果を返す。この動作を利用することで、複数台のサーバに処理を分散させることができる。  
【問題点】  
- サーバの数だけグローバルアドレスが必要
- 均等に分散されるとは限らない  
WebブラウザなどがDNS問い合わせの結果をキャッシュするため。  
- サーバがダウンしても気づかない  
DNSラウンドロビンはあくまで負荷分散の仕組みであり、冗長化の仕組みではないため、ヘルスチェックやフェイルオーバーを実装する必要がある。

### 1.3 Webサーバを冗長化する 〜IPVSでロードバランサ〜
ロードバランサは、1つのIPアドレスに対するリクエストを複数のサーバへ分散することができる。DNSラウンドロビンと比較して、ロードバランサを利用すると、グローバルアドレスが節約できることや、容易に冗長構成を組めるといった利点がある。  
ロードバランサは、サービス用のグローバルアドレスを持った仮想的なサーバとして動作する。  
#### ロードバランサの種類
ロードバランサには大きく分けてL4スイッチとL7スイッチがある。（単にロードバランサといった場合L4スイッチを指すことが多い）  
L4スイッチはトランスポート層までの情報を解析するので、IPアドレスやポート番号によって分散先のサーバを指定することができる。  
L7スイッチはアプリケーション層までの情報を解析するので、クライアントからリクエストされたURLによって分散先のサーバを指定することができる。  
IPVSに実装されているのはL4スイッチ相当の機能である。  
IPVSの機能が利用可能なソフトウェア  
- ipvsadm  
- keepalived  

### 1.4 ルータやロードバランサの冗長化
#### 冗長化プロトコル（VRRP: Virtual Router Redundancy Protocol）  
ベンダ非依存の冗長化プロトコル。  
keepalivedでもVRRPを利用できるので、ロードバランサをもう1台構築してkeepalivedの設定を追加するだけで冗長化することができる。
