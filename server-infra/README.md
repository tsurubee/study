# サーバ/インフラを支える技術  
## 用語の整理
* CDN（Content Delivery Network）：コンテンツを配信するためのネットワークシステム。世界中に点在するキャッシュサーバの中から、クライアントにより近いキャッシュサーバを選び配信することにより、性能向上を実現している。  
* LVS（Linux Virtual Server）：Linuxでスケーラブルで可用性の高いシステムを作ろうと目指しているプロジェクト。（慣習的に「Linuxで作ったロードバランサ」を指すこともある）その成果物の一つにLinuxロードバランサのためのIPVSがある。  
* フェイルオーバ（Failover）：冗長化されたシステムにおいて、Activeなノードが停止した際に、自動的にBackupノードに切り替わること。自動ではなく手動で切り替えることは「スイッチオーバ」という。  
* ヘルスチェック（Health Check）：監視対象が正常な状態にあるかどうか確認をすること。例えば、Webサーバに対して、pingが通るか、TCPの80番ポートに接続できるか、HTTPの応答があるか、など。  
* レイテンシ（latency）：データが届くまでの時間を意味する。（cf. スループットは単位時間あたりのデータ転送量）  

## 1章 サーバ/インフラ構築入門  
### 1.1 冗長化の基本
　冗長化とは、障害が発生しても予備の機材でシステムの機能を継続できるようにすること。  
以下のステップが必要である。  
1. 障害を想定する  
2. 障害に備えて予備の機材を準備する  
3. 障害が発生した際に予備の機材に切り替えられる運用体制を整備する  

冗長化されたシステムでは「現用機と予備機の構成を常に同じ状態にしておくことが定石」  
#### コールドスタンバイとホットスタンバイ
ルータなどのネットワーク機器は、運用中に頻繁に設定を変えることもないため、蓄積しなければならないデータもほとんどなく、コールドスタンバイでの運用は現実的な選択肢の一つである。  
一方で、Webサーバの場合、サイトの内容は日々更新されたり、OSのバージョンアップなども避けては通れない。そのため、Webサーバの予備機は常に電源を入れておいて、現用機が内容を更新する際には予備機にも同じ更新がかかるような運用にしたほうがよい。これをホットスタンバイという。  

### 1.2 Webサーバを冗長化する 〜DNSラウンドロビン〜
DNSラウンドロビンとは、DNSを利用して一つのサービスに複数台のサーバを分散させる手法。  
DNSサーバは、同じ名前に複数のレコードが登録されると、問い合わせのたびに異なる結果を返す。この動作を利用することで、複数台のサーバに処理を分散させることができる。  
【問題点】  
- サーバの数だけグローバルアドレスが必要
- 均等に分散されるとは限らない  
WebブラウザなどがDNS問い合わせの結果をキャッシュするため。  
- サーバがダウンしても気づかない  
DNSラウンドロビンはあくまで負荷分散の仕組みであり、冗長化の仕組みではないため、ヘルスチェックやフェイルオーバーを実装する必要がある。

### 1.3 Webサーバを冗長化する 〜IPVSでロードバランサ〜
ロードバランサは、1つのIPアドレスに対するリクエストを複数のサーバへ分散することができる。DNSラウンドロビンと比較して、ロードバランサを利用すると、グローバルアドレスが節約できることや、容易に冗長構成を組めるといった利点がある。  
ロードバランサは、サービス用のグローバルアドレスを持った仮想的なサーバとして動作する。  
#### ロードバランサの種類
ロードバランサには大きく分けてL4スイッチとL7スイッチがある。（単にロードバランサといった場合L4スイッチを指すことが多い）  
L4スイッチはトランスポート層までの情報を解析するので、IPアドレスやポート番号によって分散先のサーバを指定することができる。  
L7スイッチはアプリケーション層までの情報を解析するので、クライアントからリクエストされたURLによって分散先のサーバを指定することができる。  
IPVSに実装されているのはL4スイッチ相当の機能である。  
IPVSの機能が利用可能なソフトウェア  
- ipvsadm  
- keepalived  

### 1.4 ルータやロードバランサの冗長化
#### 冗長化プロトコル（VRRP: Virtual Router Redundancy Protocol）  
ベンダ非依存の冗長化プロトコル。  
keepalivedでもVRRPを利用できるので、ロードバランサをもう1台構築してkeepalivedの設定を追加するだけで冗長化することができる。

## 2章 ワンランク上のサーバ/インフラの構築  
### 2.1 リバースプロキシの導入
ロードバランサとWebサーバの間にリバースプロキシと呼ばれる役割のサーバを挟むことで、より柔軟な負荷分散が可能となる。  
リバースプロキシを利用すると、クライアントからの要求がWebサーバに届く途中の処理に割って入って、さまざまな前後処理を施すことができるようになる。  
以下、リバースプロキシ導入の利点を挙げていく。  
1. HTTPリクエストの内容に応じたシステムの動作の制御  
IPVSはL4なので、クライアントから要求されたHTTPリクエストの内容に応じて処理を振り分けることはできない。  
ここでリバースプロキシがあると、たとえばHTTPリクエストの中からURLを見て、URLが/images/なら画像用のWebサーバ、/newsなら動的コンテンツを作成するWebサーバに処理を振り分けるといった制御が可能になる。

2. システム全体のメモリ使用効率の向上  
動的コンテンツを返却するWebサーバ（APサーバ）では、アプリケーションが利用するプログラムをメモリに常駐させておき、アプリケーション起動時のオーバーヘッドを回避する設計がなされている。そのため、APサーバには大量のメモリが要求される。また、APサーバはクライアント1リクエストに対して1プロセスもしくは1スレッドを割り当てて処理をする方式を取っている。これにより、画像やCSSのような静的コンテンツを返すだけの場合もメモリを大量に消費することになる。  
そこで静的なファイルを返却するWebサーバと、動的コンテンツを生成するAPサーバを別のサーバとして切り分け、静的コンテンツはメモリ消費量の少ないWebサーバが応答し、動的コンテンツのみアプリケーションで応答する構成にすることで、システム全体で見た場合のメモリ使用効率が上がり、同時に処理できるリクエスト数が向上する。この場合のリクエストの振り分けにリバースプロキシを用いるのが有効である。このとき、リバースプロキシ自身もWebサーバであるという特徴を生かして静的コンテンツはリバースプロキシ自身が返却するという構成が一般的である。

3. Webサーバが応答するデータのバッファリングの役割  
#### HTTPのKeep-Alive
あるクライアントが一度に多数のコンテンツを同一のWebサーバから取得する場合、多数のHTTPリクエストごとにサーバとの接続を確立しては切断して‥を繰り返すのは効率がよくない。
HTTPにはKeep-Aliveという仕様があり、これを用いると、最初の1リクエストで確立したサーバとの接続を、そのリクエストが終了した後も切断せずに維持して、続くリクエストでその接続を使い回すことができる。  
リバースプロキシ役のWebサーバは、APサーバと比べプロセスあたりのメモリ使用量がそれほど多くないため、クライアントとリバースプロキシの間のみKeep-Aliveをオンにして、リバースプロキシとAPサーバ側はオフにすることで、クライアントとの接続の維持をリバースプロキシに任せることができる。

4. Apacheモジュールを利用した処理の制御  
リバースプロキシにApacheを採用した場合、そのリバースプロキシにApacheモジュールを組み込んで、HTTPリクエストの前処理/後処理として任意のプログラムを動かすことが可能になる。例えば、mod_dosdetectorはApache2.2用のDos攻撃対策用モジュールで、特定クライアントからの過剰なアクセスを一時的に遮断したりすることができるモジュールである。  
### 2.2 キャッシュサーバの導入
